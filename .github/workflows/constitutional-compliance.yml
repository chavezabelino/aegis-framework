name: Aegis Constitutional Compliance

on:
  push:
    branches: [ main, develop, feature/**, governance/** ]
  pull_request:
    branches: [ main, develop ]

jobs:
  governance:
    name: Governance Suite (${{ matrix.group }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        group: [validation, prevention, intelligence, monitoring, utilities]
    env:
      # Default to DRY-RUN; tighten per-branch as you progress the rollout.
      AEGIS_GOVERNANCE_MODE: dry-run
      AEGIS_ENFORCE_VALIDATION: ${{ matrix.group == 'validation' && '1' || '0' }}
      AEGIS_ENFORCE_PREVENTION: ${{ matrix.group == 'prevention' && '1' || '0' }}
      AEGIS_ENFORCE_INTEL: ${{ matrix.group == 'intelligence' && '1' || '0' }}
      AEGIS_ENFORCE_MONITORING: ${{ matrix.group == 'monitoring' && '1' || '0' }}
      AEGIS_INTEL_THRESHOLD: "0.90"
      TS_RUNNER: tsx
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install CI CLIs
        run: |
          npm i -g tsx actionlint@1

      - name: Run Governance Group
        run: node tools/ci/run-governance-suite.mjs --group ${{ matrix.group }}

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: aegis-${{ matrix.group }}-artifacts
          path: .aegis-artifacts/latest-${{ matrix.group }}.json
